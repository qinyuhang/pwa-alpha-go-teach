/*!
 * Copyright (c) 2013 Jan Prokop
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this
 * software and associated documentation files (the "Software"), to deal in the Software
 * without restriction, including without limitation the rights to use, copy, modify, merge,
 * publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons
 * to whom the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or
 * substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING
 * BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * WGo.js 2.3.1
 *
 * @license
 */
!function(window,undefined){"use strict";var scripts=document.getElementsByTagName("script"),WGo={version:"2.3.1",B:1,W:-1,ERROR_REPORT:!0,DIR:scripts[scripts.length-1].src.split("?")[0].split("/").slice(0,-1).join("/")+"/",lang:"en",i18n:{en:{}}};WGo.opera=-1!=navigator.userAgent.search(/(opera)(?:.*version)?[ \/]([\w.]+)/i),WGo.webkit=-1!=navigator.userAgent.search(/(webkit)[ \/]([\w.]+)/i),WGo.msie=-1!=navigator.userAgent.search(/(msie) ([\w.]+)/i),WGo.mozilla=-1!=navigator.userAgent.search(/(mozilla)(?:.*? rv:([\w.]+))?/i)&&!WGo.webkit&&!WGo.msie,WGo.t=function(str){var loc=WGo.i18n[WGo.lang][str]||WGo.i18n.en[str];if(loc){for(var i=1;i<arguments.length;i++)loc=loc.replace("$",arguments[i]);return loc}return str},WGo.extendClass=function(parent,child){return child.prototype=Object.create(parent.prototype),child.prototype.constructor=child,child.prototype.super=parent,child},WGo.abstractMethod=function(){throw Error("unimplemented abstract method")},WGo.clone=function(obj){if(obj&&"object"==typeof obj){var n_obj=obj.constructor==Array?[]:{};for(var key in obj)obj[key]==obj?n_obj[key]=obj:n_obj[key]=WGo.clone(obj[key]);return n_obj}return obj},WGo.filterHTML=function(text){return text&&"string"==typeof text?text.replace(/</g,"&lt;").replace(/>/g,"&gt;"):text};var Board=function(elem,config){config=config||{};for(var key in config)this[key]=config[key];for(var key in WGo.Board.default)void 0===this[key]&&(this[key]=WGo.Board.default[key]);for(var key in Board.themes.default)void 0===this.theme[key]&&(this.theme[key]=Board.themes.default[key]);this.tx=this.section.left,this.ty=this.section.top,this.bx=this.size-1-this.section.right,this.by=this.size-1-this.section.bottom,this.init(),elem.appendChild(this.element),this.pixelRatio=window.devicePixelRatio||1,this.width&&this.height?this.setDimensions(this.width,this.height):this.width?this.setWidth(this.width):this.height&&this.setHeight(this.height)};Board.themes={},Board.themes.old={shadowColor:"rgba(32,32,32,0.5)",shadowTransparentColor:"rgba(32,32,32,0)",shadowBlur:0,shadowSize:function(board){return board.shadowSize},markupBlackColor:"rgba(255,255,255,0.8)",markupWhiteColor:"rgba(0,0,0,0.8)",markupNoneColor:"rgba(0,0,0,0.8)",markupLinesWidth:function(board){return board.autoLineWidth?board.stoneRadius/7:board.lineWidth},gridLinesWidth:1,gridLinesColor:function(board){return"rgba(0,0,0,"+Math.min(1,board.stoneRadius/15)+")"},starColor:"#000",starSize:function(board){return board.starSize*(board.width/300+1)},stoneSize:function(board){return board.stoneSize*Math.min(board.fieldWidth,board.fieldHeight)/2},coordinatesColor:"rgba(0,0,0,0.7)",font:function(board){return board.font},linesShift:.5},Board.themes.default={shadowColor:"rgba(62,32,32,0.5)",shadowTransparentColor:"rgba(62,32,32,0)",shadowBlur:function(board){return.1*board.stoneRadius},shadowSize:1,markupBlackColor:"rgba(255,255,255,0.9)",markupWhiteColor:"rgba(0,0,0,0.7)",markupNoneColor:"rgba(0,0,0,0.7)",markupLinesWidth:function(board){return board.stoneRadius/8},gridLinesWidth:function(board){return board.stoneRadius/15},gridLinesColor:"#654525",starColor:"#531",starSize:function(board){return board.stoneRadius/8+1},stoneSize:function(board){return Math.min(board.fieldWidth,board.fieldHeight)/2},coordinatesColor:"#531",variationColor:"rgba(0,32,128,0.8)",font:"calibri",linesShift:.25};var shell_seed,theme_variable=function(key,board){return"function"==typeof board.theme[key]?board.theme[key](board):board.theme[key]},shadow_handler={draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.beginPath();var blur=theme_variable("shadowBlur",board),radius=Math.max(0,sr-.5),gradient=this.createRadialGradient(xr-board.ls,yr-board.ls,radius-1-blur,xr-board.ls,yr-board.ls,radius+blur);gradient.addColorStop(0,theme_variable("shadowColor",board)),gradient.addColorStop(1,theme_variable("shadowTransparentColor",board)),this.fillStyle=gradient,this.arc(xr-board.ls,yr-board.ls,radius+blur,0,2*Math.PI,!0),this.fill()},clear:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.clearRect(xr-1.1*sr-board.ls,yr-1.1*sr-board.ls,2.2*sr,2.2*sr)}},shadow_handler_realistic={draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.beginPath();var radius=Math.max(0,.85*(sr-.5)),gradient=this.createRadialGradient(xr-1,yr- -5,radius-1-5,xr-1,yr- -5,radius+5);gradient.addColorStop(0,theme_variable("shadowColor",board)),gradient.addColorStop(1,theme_variable("shadowTransparentColor",board)),this.fillStyle=gradient,this.arc(xr-1,yr- -5,radius+5,0,2*Math.PI,!0),this.fill()},clear:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.clearRect(xr-1.1*sr-1,yr-1.1*sr- -5,2.2*sr,2.2*sr)}},get_markup_color=function(board,x,y){return board.obj_arr[x][y][0].c==WGo.B?theme_variable("markupBlackColor",board):board.obj_arr[x][y][0].c==WGo.W?theme_variable("markupWhiteColor",board):theme_variable("markupNoneColor",board)},is_here_stone=function(board,x,y){return board.obj_arr[x][y][0]&&board.obj_arr[x][y][0].c==WGo.W||board.obj_arr[x][y][0].c==WGo.B},redraw_layer=function(board,layer){board[layer].clear(),board[layer].draw(board);for(var x=0;x<board.size;x++)for(var y=0;y<board.size;y++)for(var z=0;z<board.obj_arr[x][y].length;z++){(handler=(obj=board.obj_arr[x][y][z]).type?"string"==typeof obj.type?Board.drawHandlers[obj.type]:obj.type:board.stoneHandler)[layer]&&handler[layer].draw.call(board[layer].getContext(obj),obj,board)}for(var i=0;i<board.obj_list.length;i++){var handler,obj=board.obj_list[i];(handler=obj.handler)[layer]&&handler[layer].draw.call(board[layer].getContext(obj.args),obj.args,board)}},draw_shell_line=function(ctx,x,y,radius,start_angle,end_angle,factor,thickness){ctx.strokeStyle="rgba(64,64,64,0.2)",ctx.lineWidth=radius/30*thickness,ctx.beginPath();var m,angle,diff_x,diff_y,x1=x+(radius-=Math.max(1,ctx.lineWidth))*Math.cos(start_angle*Math.PI),y1=y+radius*Math.sin(start_angle*Math.PI),x2=x+radius*Math.cos(end_angle*Math.PI),y2=y+radius*Math.sin(end_angle*Math.PI);x2>x1?(m=(y2-y1)/(x2-x1),angle=Math.atan(m)):x2==x1?angle=Math.PI/2:(m=(y2-y1)/(x2-x1),angle=Math.atan(m)-Math.PI);var c=factor*radius,bx1=x1+(diff_x=Math.sin(angle)*c),by1=y1-(diff_y=Math.cos(angle)*c),bx2=x2+diff_x,by2=y2-diff_y;ctx.moveTo(x1,y1),ctx.bezierCurveTo(bx1,by1,bx2,by2,x2,y2),ctx.stroke()},draw_shell=function(arg){for(var from_angle=arg.angle,to_angle=arg.angle,i=0;i<arg.lines.length;i++)from_angle+=arg.lines[i],to_angle-=arg.lines[i],draw_shell_line(arg.ctx,arg.x,arg.y,arg.radius,from_angle,to_angle,arg.factor,arg.thickness)};Board.drawHandlers={NORMAL:{stone:{draw:function(args,board){var radgrad,xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;args.c==WGo.W?((radgrad=this.createRadialGradient(xr-2*sr/5,yr-2*sr/5,sr/3,xr-sr/5,yr-sr/5,5*sr/5)).addColorStop(0,"#fff"),radgrad.addColorStop(1,"#aaa")):((radgrad=this.createRadialGradient(xr-2*sr/5,yr-2*sr/5,1,xr-sr/5,yr-sr/5,4*sr/5)).addColorStop(0,"#666"),radgrad.addColorStop(1,"#000")),this.beginPath(),this.fillStyle=radgrad,this.arc(xr-board.ls,yr-board.ls,Math.max(0,sr-.5),0,2*Math.PI,!0),this.fill()}},shadow:shadow_handler},PAINTED:{stone:{draw:function(args,board){var radgrad,xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;args.c==WGo.W?((radgrad=this.createRadialGradient(xr-2*sr/5,yr-2*sr/5,2,xr-sr/5,yr-sr/5,4*sr/5)).addColorStop(0,"#fff"),radgrad.addColorStop(1,"#ddd")):((radgrad=this.createRadialGradient(xr-2*sr/5,yr-2*sr/5,1,xr-sr/5,yr-sr/5,4*sr/5)).addColorStop(0,"#111"),radgrad.addColorStop(1,"#000")),this.beginPath(),this.fillStyle=radgrad,this.arc(xr-board.ls,yr-board.ls,Math.max(0,sr-.5),0,2*Math.PI,!0),this.fill(),this.beginPath(),this.lineWidth=sr/6,args.c==WGo.W?(this.strokeStyle="#999",this.arc(xr+sr/8,yr+sr/8,sr/2,0,Math.PI/2,!1)):(this.strokeStyle="#ccc",this.arc(xr-sr/8,yr-sr/8,sr/2,Math.PI,1.5*Math.PI)),this.stroke()}},shadow:shadow_handler},REALISTIC:{stone:{draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius,whiteCount=board.whiteStoneGraphic.length,blackCount=board.blackStoneGraphic.length;void 0===this.randIndex&&(this.randIndex=Math.ceil(1e5*Math.random()));var redraw=function(){board.redraw()},isOkay=function(img){return"string"!=typeof img&&(!!img.complete&&(void 0===img.naturalWidth||0!=img.naturalWidth))};if(args.c==WGo.W){idx=this.randIndex%whiteCount;if("string"==typeof board.whiteStoneGraphic[idx]){(stoneGraphic=new Image).onload=redraw,stoneGraphic.src=board.whiteStoneGraphic[idx],board.whiteStoneGraphic[idx]=stoneGraphic}isOkay(board.whiteStoneGraphic[idx])?this.drawImage(board.whiteStoneGraphic[idx],xr-sr,yr-sr,2*sr,2*sr):Board.drawHandlers.SHELL.stone.draw.call(this,args,board)}else{var idx=this.randIndex%blackCount;if("string"==typeof board.blackStoneGraphic[idx]){var stoneGraphic=new Image;stoneGraphic.onload=redraw,stoneGraphic.src=board.blackStoneGraphic[idx],board.blackStoneGraphic[idx]=stoneGraphic}isOkay(board.blackStoneGraphic[idx])?this.drawImage(board.blackStoneGraphic[idx],xr-sr,yr-sr,2*sr,2*sr):Board.drawHandlers.SHELL.stone.draw.call(this,args,board)}}},shadow:shadow_handler_realistic},GLOW:{stone:{draw:function(args,board){var radgrad,xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;args.c==WGo.W?((radgrad=this.createRadialGradient(xr-2*sr/5,yr-2*sr/5,sr/3,xr-sr/5,yr-sr/5,8*sr/5)).addColorStop(0,"#fff"),radgrad.addColorStop(1,"#666")):((radgrad=this.createRadialGradient(xr-2*sr/5,yr-2*sr/5,1,xr-sr/5,yr-sr/5,3*sr/5)).addColorStop(0,"#555"),radgrad.addColorStop(1,"#000")),this.beginPath(),this.fillStyle=radgrad,this.arc(xr-board.ls,yr-board.ls,Math.max(0,sr-.5),0,2*Math.PI,!0),this.fill()}},shadow:shadow_handler},SHELL:{stone:{draw:function(args,board){var xr,yr,sr=board.stoneRadius;shell_seed=shell_seed||Math.ceil(9999999*Math.random()),xr=board.getX(args.x),yr=board.getY(args.y);var radgrad;if(radgrad=args.c==WGo.W?"#aaa":"#000",this.beginPath(),this.fillStyle=radgrad,this.arc(xr-board.ls,yr-board.ls,Math.max(0,sr-.5),0,2*Math.PI,!0),this.fill(),args.c==WGo.W){var type=shell_seed%(3+args.x*board.size+args.y)%3,z=board.size*board.size+args.x*board.size+args.y,angle=2/z*(shell_seed%z);draw_shell(0==type?{ctx:this,x:xr,y:yr,radius:sr,angle:angle,lines:[.1,.12,.11,.1,.09,.09,.09,.09],factor:.25,thickness:1.75}:1==type?{ctx:this,x:xr,y:yr,radius:sr,angle:angle,lines:[.1,.09,.08,.07,.06,.06,.06,.06,.06,.06,.06],factor:.2,thickness:1.5}:{ctx:this,x:xr,y:yr,radius:sr,angle:angle,lines:[.12,.14,.13,.12,.12,.12],factor:.3,thickness:2}),(radgrad=this.createRadialGradient(xr-2*sr/5,yr-2*sr/5,sr/3,xr-sr/5,yr-sr/5,5*sr/5)).addColorStop(0,"rgba(255,255,255,0.9)"),radgrad.addColorStop(1,"rgba(255,255,255,0)"),this.beginPath(),this.fillStyle=radgrad,this.arc(xr-board.ls,yr-board.ls,Math.max(0,sr-.5),0,2*Math.PI,!0),this.fill()}else(radgrad=this.createRadialGradient(xr+.4*sr,yr+.4*sr,0,xr+.5*sr,yr+.5*sr,sr)).addColorStop(0,"rgba(32,32,32,1)"),radgrad.addColorStop(1,"rgba(0,0,0,0)"),this.beginPath(),this.fillStyle=radgrad,this.arc(xr-board.ls,yr-board.ls,Math.max(0,sr-.5),0,2*Math.PI,!0),this.fill(),(radgrad=this.createRadialGradient(xr-.4*sr,yr-.4*sr,1,xr-.5*sr,yr-.5*sr,1.5*sr)).addColorStop(0,"rgba(64,64,64,1)"),radgrad.addColorStop(1,"rgba(0,0,0,0)"),this.beginPath(),this.fillStyle=radgrad,this.arc(xr-board.ls,yr-board.ls,Math.max(0,sr-.5),0,2*Math.PI,!0),this.fill()}},shadow:shadow_handler},MONO:{stone:{draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius,lw=theme_variable("markupLinesWidth",board)||1;args.c==WGo.W?this.fillStyle="white":this.fillStyle="black",this.beginPath(),this.arc(xr,yr,Math.max(0,sr-lw),0,2*Math.PI,!0),this.fill(),this.lineWidth=lw,this.strokeStyle="black",this.stroke()}}},CR:{stone:{draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.strokeStyle=args.c||get_markup_color(board,args.x,args.y),this.lineWidth=args.lineWidth||theme_variable("markupLinesWidth",board)||1,this.beginPath(),this.arc(xr-board.ls,yr-board.ls,sr/2,0,2*Math.PI,!0),this.stroke()}}},LB:{stone:{draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius,font=args.font||theme_variable("font",board)||"";this.fillStyle=args.c||get_markup_color(board,args.x,args.y),1==args.text.length?this.font=Math.round(1.5*sr)+"px "+font:2==args.text.length?this.font=Math.round(1.2*sr)+"px "+font:this.font=Math.round(sr)+"px "+font,this.beginPath(),this.textBaseline="middle",this.textAlign="center",this.fillText(args.text,xr,yr,2*sr)}},grid:{draw:function(args,board){if(!is_here_stone(board,args.x,args.y)&&!args._nodraw){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.clearRect(xr-sr,yr-sr,2*sr,2*sr)}},clear:function(args,board){is_here_stone(board,args.x,args.y)||(args._nodraw=!0,redraw_layer(board,"grid"),delete args._nodraw)}}},SQ:{stone:{draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=Math.round(board.stoneRadius);this.strokeStyle=args.c||get_markup_color(board,args.x,args.y),this.lineWidth=args.lineWidth||theme_variable("markupLinesWidth",board)||1,this.beginPath(),this.rect(Math.round(xr-sr/2)-board.ls,Math.round(yr-sr/2)-board.ls,sr,sr),this.stroke()}}},TR:{stone:{draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.strokeStyle=args.c||get_markup_color(board,args.x,args.y),this.lineWidth=args.lineWidth||theme_variable("markupLinesWidth",board)||1,this.beginPath(),this.moveTo(xr-board.ls,yr-board.ls-Math.round(sr/2)),this.lineTo(Math.round(xr-sr/2)-board.ls,Math.round(yr+sr/3)+board.ls),this.lineTo(Math.round(xr+sr/2)+board.ls,Math.round(yr+sr/3)+board.ls),this.closePath(),this.stroke()}}},MA:{stone:{draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.strokeStyle=args.c||get_markup_color(board,args.x,args.y),this.lineCap="round",this.lineWidth=2*(args.lineWidth||theme_variable("markupLinesWidth",board)||1)-1,this.beginPath(),this.moveTo(Math.round(xr-sr/2),Math.round(yr-sr/2)),this.lineTo(Math.round(xr+sr/2),Math.round(yr+sr/2)),this.moveTo(Math.round(xr+sr/2)-1,Math.round(yr-sr/2)),this.lineTo(Math.round(xr-sr/2)-1,Math.round(yr+sr/2)),this.stroke(),this.lineCap="butt"}}},SL:{stone:{draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.fillStyle=args.c||get_markup_color(board,args.x,args.y),this.beginPath(),this.rect(xr-sr/2,yr-sr/2,sr,sr),this.fill()}}},SM:{stone:{draw:function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.strokeStyle=args.c||get_markup_color(board,args.x,args.y),this.lineWidth=2*(args.lineWidth||theme_variable("markupLinesWidth",board)||1),this.beginPath(),this.arc(xr-sr/3,yr-sr/3,sr/6,0,2*Math.PI,!0),this.stroke(),this.beginPath(),this.arc(xr+sr/3,yr-sr/3,sr/6,0,2*Math.PI,!0),this.stroke(),this.beginPath(),this.moveTo(xr-sr/1.5,yr),this.bezierCurveTo(xr-sr/1.5,yr+sr/2,xr+sr/1.5,yr+sr/2,xr+sr/1.5,yr),this.stroke()}}},outline:{stone:{draw:function(args,board){args.alpha?this.globalAlpha=args.alpha:this.globalAlpha=.3,args.stoneStyle?Board.drawHandlers[args.stoneStyle].stone.draw.call(this,args,board):board.stoneHandler.stone.draw.call(this,args,board),this.globalAlpha=1}}},mini:{stone:{draw:function(args,board){board.stoneRadius=board.stoneRadius/2,args.stoneStyle?Board.drawHandlers[args.stoneStyle].stone.draw.call(this,args,board):board.stoneHandler.stone.draw.call(this,args,board),board.stoneRadius=2*board.stoneRadius}}}},Board.coordinates={grid:{draw:function(args,board){var ch,t,xright,xleft,ytop,ybottom;this.fillStyle=theme_variable("coordinatesColor",board),this.textBaseline="middle",this.textAlign="center",this.font=board.stoneRadius+"px "+(board.font||""),xright=board.getX(-.75),xleft=board.getX(board.size-.25),ytop=board.getY(-.75),ybottom=board.getY(board.size-.25);for(var i=0;i<board.size;i++)(ch=i+"A".charCodeAt(0))>="I".charCodeAt(0)&&ch++,t=board.getY(i),this.fillText(board.size-i,xright,t),this.fillText(board.size-i,xleft,t),t=board.getX(i),this.fillText(String.fromCharCode(ch),t,ytop),this.fillText(String.fromCharCode(ch),t,ybottom);this.fillStyle="black"}}},Board.CanvasLayer=function(){this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.pixelRatio=window.devicePixelRatio||1,this.pixelRatio>1&&this.context.scale(this.pixelRatio,this.pixelRatio)},Board.CanvasLayer.prototype={constructor:Board.CanvasLayer,setDimensions:function(width,height){this.element.width=width,this.element.style.width=width/this.pixelRatio+"px",this.element.height=height,this.element.style.height=height/this.pixelRatio+"px"},appendTo:function(element,weight){this.element.style.position="absolute",this.element.style.zIndex=weight,element.appendChild(this.element)},removeFrom:function(element){element.removeChild(this.element)},getContext:function(){return this.context},draw:function(board){},clear:function(){this.context.clearRect(0,0,this.element.width,this.element.height)}},Board.GridLayer=WGo.extendClass(Board.CanvasLayer,function(){this.super.call(this)}),Board.GridLayer.prototype.draw=function(board){var tmp;this.context.beginPath(),this.context.lineWidth=theme_variable("gridLinesWidth",board),this.context.strokeStyle=theme_variable("gridLinesColor",board);var tx=Math.round(board.left),ty=Math.round(board.top),bw=Math.round(board.fieldWidth*(board.size-1)),bh=Math.round(board.fieldHeight*(board.size-1));this.context.strokeRect(tx-board.ls,ty-board.ls,bw,bh);for(var i=1;i<board.size-1;i++)tmp=Math.round(board.getX(i))-board.ls,this.context.moveTo(tmp,ty),this.context.lineTo(tmp,ty+bh),tmp=Math.round(board.getY(i))-board.ls,this.context.moveTo(tx,tmp),this.context.lineTo(tx+bw,tmp);if(this.context.stroke(),this.context.fillStyle=theme_variable("starColor",board),board.starPoints[board.size])for(var key in board.starPoints[board.size])this.context.beginPath(),this.context.arc(board.getX(board.starPoints[board.size][key].x)-board.ls,board.getY(board.starPoints[board.size][key].y)-board.ls,theme_variable("starSize",board),0,2*Math.PI,!0),this.context.fill()},Board.MultipleCanvasLayer=WGo.extendClass(Board.CanvasLayer,function(){this.init(4)}),Board.MultipleCanvasLayer.prototype.init=function(n){var tmp,tmpContext;this.layers=n,this.elements=[],this.contexts=[],this.pixelRatio=window.devicePixelRatio||1;for(var i=0;i<n;i++)tmpContext=(tmp=document.createElement("canvas")).getContext("2d"),this.pixelRatio>1&&tmpContext.scale(this.pixelRatio,this.pixelRatio),this.elements.push(tmp),this.contexts.push(tmpContext)},Board.MultipleCanvasLayer.prototype.appendTo=function(element,weight){for(var i=0;i<this.layers;i++)this.elements[i].style.position="absolute",this.elements[i].style.zIndex=weight,element.appendChild(this.elements[i])},Board.MultipleCanvasLayer.prototype.removeFrom=function(element){for(var i=0;i<this.layers;i++)element.removeChild(this.elements[i])},Board.MultipleCanvasLayer.prototype.getContext=function(args){return args.x%2?args.y%2?this.contexts[0]:this.contexts[1]:args.y%2?this.contexts[2]:this.contexts[3]},Board.MultipleCanvasLayer.prototype.clear=function(element,weight){for(var i=0;i<this.layers;i++)this.contexts[i].clearRect(0,0,this.elements[i].width,this.elements[i].height)},Board.MultipleCanvasLayer.prototype.setDimensions=function(width,height){for(var i=0;i<this.layers;i++)this.elements[i].width=width,this.elements[i].style.width=width/this.pixelRatio+"px",this.elements[i].height=height,this.elements[i].style.height=height/this.pixelRatio+"px"},Board.ShadowLayer=WGo.extendClass(Board.MultipleCanvasLayer,function(board,shadowSize,shadowBlur){this.init(2),this.shadowSize=void 0===shadowSize?1:shadowSize,this.board=board}),Board.ShadowLayer.prototype.getContext=function(args){return!(args.x%2&&args.y%2)&&(args.x%2||args.y%2)?this.contexts[1]:this.contexts[0]},Board.ShadowLayer.prototype.setDimensions=function(width,height){this.super.prototype.setDimensions.call(this,width,height);for(var i=0;i<this.layers;i++)this.contexts[i].setTransform(1,0,0,1,Math.round(this.shadowSize*this.board.stoneRadius/7),Math.round(this.shadowSize*this.board.stoneRadius/7))};var default_field_clear=function(args,board){var xr=board.getX(args.x),yr=board.getY(args.y),sr=board.stoneRadius;this.clearRect(xr-2*sr-board.ls,yr-2*sr-board.ls,4*sr,4*sr)},calcLeftMargin=function(){return 3*this.width/(4*(this.bx+1-this.tx)+2)-this.fieldWidth*this.tx},calcTopMargin=function(){return 3*this.height/(4*(this.by+1-this.ty)+2)-this.fieldHeight*this.ty},calcFieldWidth=function(){return 4*this.width/(4*(this.bx+1-this.tx)+2)},calcFieldHeight=function(){return 4*this.height/(4*(this.by+1-this.ty)+2)},clearField=function(x,y){for(var handler,z=0;z<this.obj_arr[x][y].length;z++){var obj=this.obj_arr[x][y][z];handler=obj.type?"string"==typeof obj.type?Board.drawHandlers[obj.type]:obj.type:this.stoneHandler;for(var layer in handler)handler[layer].clear?handler[layer].clear.call(this[layer].getContext(obj),obj,this):default_field_clear.call(this[layer].getContext(obj),obj,this)}},drawField=function(x,y){for(var handler,z=0;z<this.obj_arr[x][y].length;z++){var obj=this.obj_arr[x][y][z];handler=obj.type?"string"==typeof obj.type?Board.drawHandlers[obj.type]:obj.type:this.stoneHandler;for(var layer in handler)handler[layer].draw.call(this[layer].getContext(obj),obj,this)}},updateDim=function(){this.element.style.width=this.width/this.pixelRatio+"px",this.element.style.height=this.height/this.pixelRatio+"px",this.stoneRadius=theme_variable("stoneSize",this),this.ls=theme_variable("linesShift",this);for(var i=0;i<this.layers.length;i++)this.layers[i].setDimensions(this.width,this.height)};Board.prototype={constructor:Board,init:function(){this.obj_arr=[];for(var i=0;i<this.size;i++){this.obj_arr[i]=[];for(var j=0;j<this.size;j++)this.obj_arr[i][j]=[]}this.obj_list=[],this.layers=[],this.listeners=[],this.element=document.createElement("div"),this.element.className="wgo-board",this.element.style.position="relative",this.background&&("#"==this.background[0]?this.element.style.backgroundColor=this.background:(this.element.style.backgroundImage="url('"+this.background+"')",this.stoneHandler==Board.drawHandlers.REALISTIC&&(this.element.style.backgroundSize="100%"))),this.grid=new Board.GridLayer,this.shadow=new Board.ShadowLayer(this,theme_variable("shadowSize",this)),this.stone=new Board.MultipleCanvasLayer,this.addLayer(this.grid,100),this.addLayer(this.shadow,200),this.addLayer(this.stone,300)},setWidth:function(width){this.width=width,this.width*=this.pixelRatio,this.fieldHeight=this.fieldWidth=calcFieldWidth.call(this),this.left=calcLeftMargin.call(this),this.height=(this.by-this.ty+1.5)*this.fieldHeight,this.top=calcTopMargin.call(this),updateDim.call(this),this.redraw()},setHeight:function(height){this.height=height,this.height*=this.pixelRatio,this.fieldWidth=this.fieldHeight=calcFieldHeight.call(this),this.top=calcTopMargin.call(this),this.width=(this.bx-this.tx+1.5)*this.fieldWidth,this.left=calcLeftMargin.call(this),updateDim.call(this),this.redraw()},setDimensions:function(width,height){this.width=width||parseInt(this.element.style.width,10),this.width*=this.pixelRatio,this.height=height||parseInt(this.element.style.height,10),this.height*=this.pixelRatio,this.fieldWidth=calcFieldWidth.call(this),this.fieldHeight=calcFieldHeight.call(this),this.left=calcLeftMargin.call(this),this.top=calcTopMargin.call(this),updateDim.call(this),this.redraw()},getSection:function(){return this.section},setSection:function(section_or_top,right,bottom,left){this.section="object"==typeof section_or_top?section_or_top:{top:section_or_top,right:right,bottom:bottom,left:left},this.tx=this.section.left,this.ty=this.section.top,this.bx=this.size-1-this.section.right,this.by=this.size-1-this.section.bottom,this.setDimensions()},setSize:function(size){if((size=size||19)!=this.size){this.size=size,this.obj_arr=[];for(var i=0;i<this.size;i++){this.obj_arr[i]=[];for(var j=0;j<this.size;j++)this.obj_arr[i][j]=[]}this.bx=this.size-1-this.section.right,this.by=this.size-1-this.section.bottom,this.setDimensions()}},redraw:function(){try{for(i=0;i<this.layers.length;i++)this.layers[i].clear(this),this.layers[i].draw(this);for(i=0;i<this.size;i++)for(var j=0;j<this.size;j++)drawField.call(this,i,j);for(var i=0;i<this.obj_list.length;i++){var obj=this.obj_list[i],handler=obj.handler;for(var layer in handler)handler[layer].draw.call(this[layer].getContext(obj.args),obj.args,this)}}catch(err){console.log("WGo board failed to render. Error: "+err.message)}},getX:function(x){return this.left+x*this.fieldWidth},getY:function(y){return this.top+y*this.fieldHeight},addLayer:function(layer,weight){layer.appendTo(this.element,weight),layer.setDimensions(this.width,this.height),this.layers.push(layer)},removeLayer:function(layer){var i=this.layers.indexOf(layer);i>=0&&(this.layers.splice(i,1),layer.removeFrom(this.element))},update:function(changes){var i;if(changes.remove&&"all"==changes.remove)this.removeAllObjects();else if(changes.remove)for(i=0;i<changes.remove.length;i++)this.removeObject(changes.remove[i]);if(changes.add)for(i=0;i<changes.add.length;i++)this.addObject(changes.add[i])},addObject:function(obj){if(obj.constructor!=Array)try{clearField.call(this,obj.x,obj.y);for(var layers=this.obj_arr[obj.x][obj.y],z=0;z<layers.length;z++)if(layers[z].type==obj.type)return layers[z]=obj,void drawField.call(this,obj.x,obj.y);obj.type?layers.push(obj):layers.unshift(obj),drawField.call(this,obj.x,obj.y)}catch(err){console.log("WGo board failed to render. Error: "+err.message)}else for(var i=0;i<obj.length;i++)this.addObject(obj[i])},removeObject:function(obj){if(obj.constructor!=Array)try{for(var i,j=0;j<this.obj_arr[obj.x][obj.y].length;j++)if(this.obj_arr[obj.x][obj.y][j].type==obj.type){i=j;break}if(void 0===i)return;clearField.call(this,obj.x,obj.y),this.obj_arr[obj.x][obj.y].splice(i,1),drawField.call(this,obj.x,obj.y)}catch(err){console.log("WGo board failed to render. Error: "+err.message)}else for(var n=0;n<obj.length;n++)this.removeObject(obj[n])},removeObjectsAt:function(x,y){this.obj_arr[x][y].length&&(clearField.call(this,x,y),this.obj_arr[x][y]=[])},removeAllObjects:function(){this.obj_arr=[];for(var i=0;i<this.size;i++){this.obj_arr[i]=[];for(var j=0;j<this.size;j++)this.obj_arr[i][j]=[]}this.redraw()},addCustomObject:function(handler,args){this.obj_list.push({handler:handler,args:args}),this.redraw()},removeCustomObject:function(handler,args){for(var i=0;i<this.obj_list.length;i++){var obj=this.obj_list[i];if(obj.handler==handler&&obj.args==args)return this.obj_list.splice(i,1),this.redraw(),!0}return!1},addEventListener:function(type,callback){var _this=this,evListener={type:type,callback:callback,handleEvent:function(e){var coo=function(e){var x,y;return x=(e.offsetX||e.layerX)*this.pixelRatio,x-=this.left,x/=this.fieldWidth,x=Math.round(x),y=(e.offsetY||e.layerY)*this.pixelRatio,y-=this.top,y/=this.fieldHeight,y=Math.round(y),{x:x>=this.size?-1:x,y:y>=this.size?-1:y}}.call(_this,e);callback(coo.x,coo.y,e)}};this.element.addEventListener(type,evListener,!0),this.listeners.push(evListener)},removeEventListener:function(type,callback){for(var i=0;i<this.listeners.length;i++){var listener=this.listeners[i];if(listener.type==type&&listener.callback==callback)return this.element.removeEventListener(listener.type,listener,!0),this.listeners.splice(i,1),!0}return!1},getState:function(){return{objects:WGo.clone(this.obj_arr),custom:WGo.clone(this.obj_list)}},restoreState:function(state){this.obj_arr=state.objects||this.obj_arr,this.obj_list=state.custom||this.obj_list,this.redraw()}},Board.default={size:19,width:0,height:0,font:"Calibri",lineWidth:1,autoLineWidth:!1,starPoints:{5:[{x:2,y:2}],7:[{x:3,y:3}],8:[{x:2,y:2},{x:5,y:2},{x:2,y:5},{x:5,y:5}],9:[{x:2,y:2},{x:6,y:2},{x:4,y:4},{x:2,y:6},{x:6,y:6}],10:[{x:2,y:2},{x:7,y:2},{x:2,y:7},{x:7,y:7}],11:[{x:2,y:2},{x:8,y:2},{x:5,y:5},{x:2,y:8},{x:8,y:8}],12:[{x:3,y:3},{x:8,y:3},{x:3,y:8},{x:8,y:8}],13:[{x:3,y:3},{x:9,y:3},{x:6,y:6},{x:3,y:9},{x:9,y:9}],14:[{x:3,y:3},{x:10,y:3},{x:3,y:10},{x:10,y:10}],15:[{x:3,y:3},{x:11,y:3},{x:7,y:7},{x:3,y:11},{x:11,y:11}],16:[{x:3,y:3},{x:12,y:3},{x:3,y:12},{x:12,y:12}],17:[{x:3,y:3},{x:8,y:3},{x:13,y:3},{x:3,y:8},{x:8,y:8},{x:13,y:8},{x:3,y:13},{x:8,y:13},{x:13,y:13}],18:[{x:3,y:3},{x:14,y:3},{x:3,y:14},{x:14,y:14}],19:[{x:3,y:3},{x:9,y:3},{x:15,y:3},{x:3,y:9},{x:9,y:9},{x:15,y:9},{x:3,y:15},{x:9,y:15},{x:15,y:15}],20:[{x:3,y:3},{x:16,y:3},{x:3,y:16},{x:16,y:16}],21:[{x:3,y:3},{x:10,y:3},{x:17,y:3},{x:3,y:10},{x:10,y:10},{x:17,y:10},{x:3,y:17},{x:10,y:17},{x:17,y:17}]},stoneHandler:Board.drawHandlers.REALISTIC,starSize:1,shadowSize:1,stoneSize:1,section:{top:0,right:0,bottom:0,left:0},background:WGo.DIR+"wood_1024.jpg",whiteStoneGraphic:[WGo.DIR+"stones/white00_128.png",WGo.DIR+"stones/white01_128.png",WGo.DIR+"stones/white02_128.png",WGo.DIR+"stones/white03_128.png",WGo.DIR+"stones/white04_128.png",WGo.DIR+"stones/white05_128.png",WGo.DIR+"stones/white06_128.png",WGo.DIR+"stones/white07_128.png",WGo.DIR+"stones/white08_128.png",WGo.DIR+"stones/white09_128.png",WGo.DIR+"stones/white10_128.png"],blackStoneGraphic:[WGo.DIR+"stones/black00_128.png",WGo.DIR+"stones/black01_128.png",WGo.DIR+"stones/black02_128.png",WGo.DIR+"stones/black03_128.png"],theme:{}},WGo.Board=Board;var Position=function(size){this.size=size||19,this.schema=[];for(var i=0;i<this.size*this.size;i++)this.schema[i]=0};Position.prototype={constructor:WGo.Position,get:function(x,y){if(!(x<0||y<0||x>=this.size||y>=this.size))return this.schema[x*this.size+y]},set:function(x,y,c){return this.schema[x*this.size+y]=c,this},clear:function(){for(var i=0;i<this.size*this.size;i++)this.schema[i]=0;return this},clone:function(){var clone=new Position(this.size);return clone.schema=this.schema.slice(0),clone},compare:function(position){for(var add=[],remove=[],i=0;i<this.size*this.size;i++)this.schema[i]&&!position.schema[i]?remove.push({x:Math.floor(i/this.size),y:i%this.size}):this.schema[i]!=position.schema[i]&&add.push({x:Math.floor(i/this.size),y:i%this.size,c:position.schema[i]});return{add:add,remove:remove}}},WGo.Position=Position;var Game=function(size,checkRepeat,allowRewrite,allowSuicide){this.size=size||19,this.repeating=void 0===checkRepeat?"KO":checkRepeat,this.allow_rewrite=allowRewrite||!1,this.allow_suicide=allowSuicide||!1,this.stack=[],this.stack[0]=new Position(this.size),this.stack[0].capCount={black:0,white:0},this.turn=WGo.B,Object.defineProperty(this,"position",{get:function(){return this.stack[this.stack.length-1]},set:function(pos){this.stack[this.stack.length-1]=pos}})},do_capture=function(position,captured,x,y,c){x>=0&&x<position.size&&y>=0&&y<position.size&&position.get(x,y)==c&&(position.set(x,y,0),captured.push({x:x,y:y}),do_capture(position,captured,x,y-1,c),do_capture(position,captured,x,y+1,c),do_capture(position,captured,x-1,y,c),do_capture(position,captured,x+1,y,c))},check_liberties=function(position,testing,x,y,c){return x<0||x>=position.size||y<0||y>=position.size||0!=position.get(x,y)&&(1==testing.get(x,y)||position.get(x,y)==-c||(testing.set(x,y,!0),check_liberties(position,testing,x,y-1,c)&&check_liberties(position,testing,x,y+1,c)&&check_liberties(position,testing,x-1,y,c)&&check_liberties(position,testing,x+1,y,c)))},check_capturing=function(position,x,y,c){var captured=[];if(x>=0&&x<position.size&&y>=0&&y<position.size&&position.get(x,y)==c){var testing=new Position(position.size);check_liberties(position,testing,x,y,c)&&do_capture(position,captured,x,y,c)}return captured};Game.prototype={constructor:Game,getPosition:function(){return this.stack[this.stack.length-1]},play:function(x,y,c,noplay){if(!this.isOnBoard(x,y))return 1;if(!this.allow_rewrite&&0!=this.position.get(x,y))return 2;c||(c=this.turn);var new_pos=this.position.clone();new_pos.set(x,y,c);var cap_color=c,captured=check_capturing(new_pos,x-1,y,-c).concat(check_capturing(new_pos,x+1,y,-c),check_capturing(new_pos,x,y-1,-c),check_capturing(new_pos,x,y+1,-c));if(!captured.length){var testing=new Position(this.size);if(check_liberties(new_pos,testing,x,y,c)){if(!this.allow_suicide)return 3;cap_color=-c,do_capture(new_pos,captured,x,y,c)}}return this.repeating&&!function(position,x,y){var flag,stop;if("KO"==this.repeating&&this.stack.length-2>=0)stop=this.stack.length-2;else{if("ALL"!=this.repeating)return!0;stop=0}for(var i=this.stack.length-2;i>=stop;i--)if(this.stack[i].get(x,y)==position.get(x,y)){flag=!0;for(var j=0;j<this.size*this.size;j++)if(this.stack[i].schema[j]!=position.schema[j]){flag=!1;break}if(flag)return!1}return!0}.call(this,new_pos,x,y)?4:!noplay&&(new_pos.color=c,new_pos.capCount={black:this.position.capCount.black,white:this.position.capCount.white},cap_color==WGo.B?new_pos.capCount.black+=captured.length:new_pos.capCount.white+=captured.length,this.pushPosition(new_pos),this.turn=-c,captured)},pass:function(c){this.pushPosition(),c?(this.position.color=c,this.turn=-c):(this.position.color=this.turn,this.turn=-this.turn)},isValid:function(x,y,c){return"number"!=typeof this.play(x,y,c,!0)},isOnBoard:function(x,y){return x>=0&&y>=0&&x<this.size&&y<this.size},addStone:function(x,y,c){return!(!this.isOnBoard(x,y)||0!=this.position.get(x,y))&&(this.position.set(x,y,c||0),!0)},removeStone:function(x,y){return!(!this.isOnBoard(x,y)||0==this.position.get(x,y))&&(this.position.set(x,y,0),!0)},setStone:function(x,y,c){return!!this.isOnBoard(x,y)&&(this.position.set(x,y,c||0),!0)},getStone:function(x,y){return this.isOnBoard(x,y)?this.position.get(x,y):0},pushPosition:function(pos){if(!pos){(pos=this.position.clone()).capCount={black:this.position.capCount.black,white:this.position.capCount.white},pos.color=this.position.color}return this.stack.push(pos),pos.color&&(this.turn=-pos.color),this},popPosition:function(){var old=null;return this.stack.length>0&&(old=this.stack.pop(),0==this.stack.length?this.turn=WGo.B:this.position.color?this.turn=-this.position.color:this.turn=-this.turn),old},firstPosition:function(){return this.stack=[],this.stack[0]=new Position(this.size),this.stack[0].capCount={black:0,white:0},this.turn=WGo.B,this},getCaptureCount:function(color){return color==WGo.B?this.position.capCount.black:this.position.capCount.white},validatePosition:function(){for(var c,p,white=0,black=0,captured=[],new_pos=this.position.clone(),x=0;x<this.size;x++)for(var y=0;y<this.size;y++)(c=this.position.get(x,y))&&(p=captured.length,captured=captured.concat(check_capturing(new_pos,x-1,y,-c),check_capturing(new_pos,x+1,y,-c),check_capturing(new_pos,x,y-1,-c),check_capturing(new_pos,x,y+1,-c)),c==WGo.B?black+=captured-p:white+=captured-p);return this.position.capCount.black+=black,this.position.capCount.white+=white,this.position.schema=new_pos.schema,captured}},WGo.Game=Game,window.WGo=WGo}(window),function(WGo,undefined){"use strict";var recursive_clone=function(node){var n=new KNode(JSON.parse(JSON.stringify(node.getProperties())));for(var ch in node.children)n.appendChild(recursive_clone(node.children[ch]));return n},find_property=function(prop,node){var res;if(void 0!==node[prop])return node[prop];for(var ch in node.children)if(res=find_property(prop,node.children[ch]))return res;return!1},recursive_save=function(gameTree,node){if(gameTree.push(JSON.parse(JSON.stringify(node.getProperties()))),node.children.length>1){for(var nt=[],i=0;i<node.children.length;i++){var t=[];recursive_save(t,node.children[i]),nt.push(t)}gameTree.push(nt)}else node.children.length&&recursive_save(gameTree,node.children[0])},recursive_save2=function(gameTree,node){for(var tnode,anode=node,i=1;i<gameTree.length;i++)if(gameTree[i].constructor==Array)for(var j=0;j<gameTree[i].length;j++)tnode=new KNode(gameTree[i][j][0]),anode.appendChild(tnode),recursive_save2(gameTree[i][j],tnode);else tnode=new KNode(gameTree[i]),anode.insertAfter(tnode),anode=tnode},sgf_escape=function(text){return"string"==typeof text?text.replace(/\\/g,"\\\\").replace(/]/g,"\\]"):text},a_char="a".charCodeAt(0),sgf_coordinates=function(x,y){return String.fromCharCode(a_char+x)+String.fromCharCode(a_char+y)},sgf_write_group=function(prop,values,output){if(values.length){output.sgf+=prop;for(var i in values)output.sgf+="["+values[i]+"]"}},sgf_write_node=function(node,output){if(node.move){var move="";node.move.pass||(move=sgf_coordinates(node.move.x,node.move.y)),node.move.c==WGo.B?output.sgf+="B["+move+"]":output.sgf+="W["+move+"]"}if(node.setup){var AB=[],AW=[],AE=[];for(var i in node.setup)node.setup[i].c==WGo.B?AB.push(sgf_coordinates(node.setup[i].x,node.setup[i].y)):node.setup[i].c==WGo.W?AW.push(sgf_coordinates(node.setup[i].x,node.setup[i].y)):AE.push(sgf_coordinates(node.setup[i].x,node.setup[i].y));sgf_write_group("AB",AB,output),sgf_write_group("AW",AW,output),sgf_write_group("AE",AE,output)}if(node.markup){var markup={};for(var i in node.markup)markup[node.markup[i].type]=markup[node.markup[i].type]||[],"LB"==node.markup[i].type?markup.LB.push(sgf_coordinates(node.markup[i].x,node.markup[i].y)+":"+sgf_escape(node.markup[i].text)):markup[node.markup[i].type].push(sgf_coordinates(node.markup[i].x,node.markup[i].y));for(var key in markup)sgf_write_group(key,markup[key],output)}var props=node.getProperties();for(var key in props)"object"!=typeof props[key]&&(output.sgf+="turn"==key?"PL["+(props[key]==WGo.B?"B":"W")+"]":"comment"==key?"C["+sgf_escape(props[key])+"]":key+"["+sgf_escape(props[key])+"]");if(1==node.children.length)output.sgf+="\n;",sgf_write_node(node.children[0],output);else if(node.children.length>1)for(var key in node.children)sgf_write_variantion(node.children[key],output)},sgf_write_variantion=function(node,output){output.sgf+="(\n;",sgf_write_node(node,output),output.sgf+="\n)"},Kifu=function(){this.size=19,this.info={},this.root=new KNode,this.nodeCount=0,this.propertyCount=0};Kifu.prototype={constructor:Kifu,clone:function(){var clone=new Kifu;return clone.size=this.size,clone.info=JSON.parse(JSON.stringify(this.info)),clone.root=recursive_clone(this.root),clone.nodeCount=this.nodeCount,clone.propertyCount=this.propertyCount,clone},hasComments:function(){return!!find_property("comment",this.root)}},Kifu.fromSgf=function(sgf){return WGo.SGF.parse(sgf)},Kifu.fromJGO=function(arg){var jgo="string"==typeof arg?JSON.parse(arg):arg,kifu=new Kifu;return kifu.info=JSON.parse(JSON.stringify(jgo.info)),kifu.size=jgo.size,kifu.nodeCount=jgo.nodeCount,kifu.propertyCount=jgo.propertyCount,kifu.root=new KNode(jgo.game[0]),recursive_save2(jgo.game,kifu.root),kifu},Kifu.prototype.toSgf=function(){var output={sgf:"(\n;"},root_props={};for(var key in this.info)"black"==key?(this.info.black.name&&(root_props.PB=sgf_escape(this.info.black.name)),this.info.black.rank&&(root_props.BR=sgf_escape(this.info.black.rank)),this.info.black.team&&(root_props.BT=sgf_escape(this.info.black.team))):"white"==key?(this.info.white.name&&(root_props.PW=sgf_escape(this.info.white.name)),this.info.white.rank&&(root_props.WR=sgf_escape(this.info.white.rank)),this.info.white.team&&(root_props.WT=sgf_escape(this.info.white.team))):root_props[key]=sgf_escape(this.info[key]);this.size&&(root_props.SZ=this.size),root_props.AP||(root_props.AP="WGo.js:2"),root_props.FF||(root_props.FF="4"),root_props.GM||(root_props.GM="1"),root_props.CA||(root_props.CA="UTF-8");for(var key in root_props)root_props[key]&&(output.sgf+=key+"["+root_props[key]+"]");return sgf_write_node(this.root,output),output.sgf+=")",output.sgf},Kifu.prototype.toJGO=function(stringify){var jgo={};return jgo.size=this.size,jgo.info=JSON.parse(JSON.stringify(this.info)),jgo.nodeCount=this.nodeCount,jgo.propertyCount=this.propertyCount,jgo.game=[],recursive_save(jgo.game,this.root),stringify?JSON.stringify(jgo):jgo};var player_formatter=function(value){var str;return value.name?(str=WGo.filterHTML(value.name),value.rank&&(str+=" ("+WGo.filterHTML(value.rank)+")"),value.team&&(str+=", "+WGo.filterHTML(value.team))):(value.team&&(str=WGo.filterHTML(value.team)),value.rank&&(str+=" ("+WGo.filterHTML(value.rank)+")")),str};Kifu.infoFormatters={black:player_formatter,white:player_formatter,TM:function(time){if(0==time)return WGo.t("none");var res,t=Math.floor(time/60);return 1==t?res="1 "+WGo.t("minute"):t>1&&(res=t+" "+WGo.t("minutes")),1==(t=time%60)?res+=" 1 "+WGo.t("second"):t>1&&(res+=" "+t+" "+WGo.t("seconds")),res},RE:function(res){return'<a href="javascript: void(0)" onclick="this.parentNode.innerHTML = \''+WGo.filterHTML(res)+'\'" title="'+WGo.t("res-show-tip")+'">'+WGo.t("show")+"</a>"}},Kifu.infoList=["black","white","AN","CP","DT","EV","GN","GC","HA","ON","OT","RE","RO","RU","SO","TM","US","PC","KM"],WGo.Kifu=Kifu;var no_add=function(arr,obj,key){for(var i=0;i<arr.length;i++)if(arr[i].x==obj.x&&arr[i].y==obj.y)return void(arr[i][key]=obj[key]);arr.push(obj)},no_remove=function(arr,obj){if(arr)for(var i=0;i<arr.length;i++)if(arr[i].x==obj.x&&arr[i].y==obj.y)return void arr.splice(i,1)},KNode=function(properties,parent){if(this.parent=parent||null,this.children=[],properties)for(var key in properties)this[key]=properties[key]};KNode.prototype={constructor:KNode,getChild:function(ch){var i=ch||0;return this.children[i]?this.children[i]:null},addSetup:function(setup){return this.setup=this.setup||[],no_add(this.setup,setup,"c"),this},removeSetup:function(setup){return no_remove(this.setup,setup),this},addMarkup:function(markup){return this.markup=this.markup||[],no_add(this.markup,markup,"type"),this},removeMarkup:function(markup){return no_remove(this.markup,markup),this},remove:function(){var p=this.parent;if(!p)throw new Exception("Root node cannot be removed");for(var i in p.children)if(p.children[i]==this){p.children.splice(i,1);break}return p.children=p.children.concat(this.children),this.parent=null,p},insertAfter:function(node){for(var child in this.children)this.children[child].parent=node;return node.children=node.children.concat(this.children),node.parent=this,this.children=[node],node},appendChild:function(node){return node.parent=this,this.children.push(node),node},getProperties:function(){var props={};for(var key in this)this.hasOwnProperty(key)&&"children"!=key&&"parent"!=key&&"_"!=key[0]&&(props[key]=this[key]);return props}},WGo.KNode=KNode;var pos_diff=function(old_p,new_p){for(var size=old_p.size,add=[],remove=[],i=0;i<size*size;i++)old_p.schema[i]&&!new_p.schema[i]?remove.push({x:Math.floor(i/size),y:i%size}):old_p.schema[i]!=new_p.schema[i]&&add.push({x:Math.floor(i/size),y:i%size,c:new_p.schema[i]});return{add:add,remove:remove}},KifuReader=function(kifu,rememberPath,allowIllegalMoves){this.kifu=kifu,this.node=this.kifu.root,this.allow_illegal=allowIllegalMoves||!1,this.game=new WGo.Game(this.kifu.size,this.allow_illegal?"NONE":"KO",this.allow_illegal,this.allow_illegal),this.path={m:0},this.kifu.info.HA&&this.kifu.info.HA>1&&(this.game.turn=WGo.W),this.change=exec_node(this.game,this.node,!0),this.rememberPath=!!rememberPath},set_subtract=function(a,b){var q,n=[];for(var i in a){q=!0;for(var j in b)if(a[i].x==b[j].x&&a[i].y==b[j].y){q=!1;break}q&&n.push(a[i])}return n},concat_changes=function(ch_orig,ch_new){ch_orig.add=set_subtract(ch_orig.add,ch_new.remove).concat(ch_new.add),ch_orig.remove=set_subtract(ch_orig.remove,ch_new.add).concat(ch_new.remove)},exec_node=function(game,node,first){if(node.parent&&(node.parent._last_selected=node.parent.children.indexOf(node)),void 0!=node.move){if(node.move.pass)return game.pass(node.move.c),{add:[],remove:[]};var res=game.play(node.move.x,node.move.y,node.move.c);if("number"==typeof res)throw new InvalidMoveError(res,node);for(var i in res)if(res[i].x==node.move.x&&res[i].y==node.move.y)return{add:[],remove:res};return{add:[node.move],remove:res}}first||game.pushPosition();var add=[],remove=[];if(void 0!=node.setup)for(var i in node.setup)node.setup[i].c?(game.setStone(node.setup[i].x,node.setup[i].y,node.setup[i].c),add.push(node.setup[i])):(game.removeStone(node.setup[i].x,node.setup[i].y),remove.push(node.setup[i]));return node.turn&&(game.turn=node.turn),{add:add,remove:remove}},exec_next=function(i,findAGMove){if(void 0===findAGMove&&(findAGMove=!0),void 0===i&&this.rememberPath&&(i=this.node._last_selected),findAGMove)for(var j=0;j<this.node.children.length;j++)if(this.node.children[j].isAGMove){i=j;break}i=i||0;var node=this.node.children[i];if(!node)return!1;var ch=exec_node(this.game,node);return this.path.m++,this.node.children.length>1&&(this.path[this.path.m]=i),this.node=node,this.node.parent&&this.node.parent.parent&&void 0!=stateKeeper&&stateKeeper.addDeputyChildrenIfPresent(stateKeeper.treeNodeFromKifuNode(this.node),this.node),ch},exec_previous=function(){return!!this.node.parent&&(this.node=this.node.parent,this.game.popPosition(),this.node.turn&&(this.game.turn=this.node.turn),void 0!==this.path[this.path.m]&&delete this.path[this.path.m],this.path.m--,!0)},exec_first=function(){this.game.firstPosition(),this.node=this.kifu.root,this.path={m:0},this.kifu.info.HA&&this.kifu.info.HA>1&&(this.game.turn=WGo.W),this.change=exec_node(this.game,this.node,!0)};KifuReader.prototype={constructor:KifuReader,next:function(i,findAGMove){return this.change=exec_next.call(this,i,findAGMove),this},last:function(){var ch;for(this.change={add:[],remove:[]};ch=exec_next.call(this);)concat_changes(this.change,ch);return this},previous:function(){var old_pos=this.game.getPosition();return exec_previous.call(this),this.change=pos_diff(old_pos,this.game.getPosition()),this},first:function(){var old_pos=this.game.getPosition();return exec_first.call(this),this.change=pos_diff(old_pos,this.game.getPosition()),this},goTo:function(path){if(void 0===path)return this;var old_pos=this.game.getPosition();exec_first.call(this);for(var i=0;i<path.m&&exec_next.call(this,path[i+1]);i++);return this.change=pos_diff(old_pos,this.game.getPosition()),this},previousFork:function(){for(var old_pos=this.game.getPosition();exec_previous.call(this)&&1==this.node.children.length;);return this.change=pos_diff(old_pos,this.game.getPosition()),this},getPosition:function(){return this.game.getPosition()},allowIllegalMoves:function(b){b?(this.game.allow_rewrite=!0,this.game.allow_suicide=!0,this.repeating="NONE"):(this.game.allow_rewrite=!1,this.game.allow_suicide=!1,this.repeating="KO")}},WGo.KifuReader=KifuReader;var InvalidMoveError=function(code,node){if(this.name="InvalidMoveError",this.message="Invalid move in kifu detected. ",node.move&&void 0!==node.move.c&&void 0!==node.move.x&&void 0!==node.move.y){var letter=node.move.x;node.move.x>7&&letter++,letter=String.fromCharCode(letter+65),this.message+="Trying to play "+(node.move.c==WGo.WHITE?"white":"black")+" move on "+String.fromCharCode(node.move.x+65)+(19-node.move.y)}else this.message+="Move object doesn't contain arbitrary attributes.";if(code)switch(code){case 1:this.message+=", but these coordinates are not on board.";break;case 2:this.message+=", but there already is a stone.";break;case 3:this.message+=", but this move is a suicide.";break;case 4:this.message+=", but this position already occured."}else this.message+="."};InvalidMoveError.prototype=new Error,InvalidMoveError.prototype.constructor=InvalidMoveError,WGo.InvalidMoveError=InvalidMoveError,WGo.i18n.en.show="show",WGo.i18n.en["res-show-tip"]="Click to show result."}(WGo),function(WGo,undefined){WGo.SGF={};var to_num=function(str,i){return str.charCodeAt(i)-97},sgf_player_info=function(type,black,kifu,node,value,ident){var c=ident==black?"black":"white";kifu.info[c]=kifu.info[c]||{},kifu.info[c][type]=value[0]},properties=WGo.SGF.properties={};properties.B=properties.W=function(kifu,node,value,ident){!value[0]||kifu.size<=19&&"tt"==value[0]?node.move={pass:!0,c:"B"==ident?WGo.B:WGo.W}:node.move={x:to_num(value[0],0),y:to_num(value[0],1),c:"B"==ident?WGo.B:WGo.W}},properties.AB=properties.AW=function(kifu,node,value,ident){for(var i in value)node.addSetup({x:to_num(value[i],0),y:to_num(value[i],1),c:"AB"==ident?WGo.B:WGo.W})},properties.AE=function(kifu,node,value){for(var i in value)node.addSetup({x:to_num(value[i],0),y:to_num(value[i],1)})},properties.PL=function(kifu,node,value){node.turn="b"==value[0]||"B"==value[0]?WGo.B:WGo.W},properties.C=function(kifu,node,value){node.comment=value.join()},properties.LB=function(kifu,node,value){for(var i in value)node.addMarkup({x:to_num(value[i],0),y:to_num(value[i],1),type:"LB",text:value[i].substr(3)})},properties.CR=properties.SQ=properties.TR=properties.SL=properties.MA=function(kifu,node,value,ident){for(var i in value)node.addMarkup({x:to_num(value[i],0),y:to_num(value[i],1),type:ident})},properties.SZ=function(kifu,node,value){kifu.size=parseInt(value[0])},properties.BR=properties.WR=sgf_player_info.bind(this,"rank","BR"),properties.PB=properties.PW=sgf_player_info.bind(this,"name","PB"),properties.BT=properties.WT=sgf_player_info.bind(this,"team","BT"),properties.TM=function(kifu,node,value,ident){kifu.info[ident]=value[0],node.BL=value[0],node.WL=value[0]};var reg_seq=/\(|\)|(;(\s*[A-Z]+(\s*((\[\])|(\[(.|\s)*?([^\\]\]))))+)*)/g,reg_node=/[A-Z]+(\s*((\[\])|(\[(.|\s)*?([^\\]\]))))+/g,reg_ident=/[A-Z]+/,reg_props=/(\[\])|(\[(.|\s)*?([^\\]\]))/g;WGo.SGF.parse=function(str){var sequence,props,vals,ident,stack=[],kifu=new WGo.Kifu,node=null;sequence=str.match(reg_seq);for(var i in sequence)if("("==sequence[i])stack.push(node);else if(")"==sequence[i])node=stack.pop();else{node&&kifu.nodeCount++,node=node?node.appendChild(new WGo.KNode):kifu.root,props=sequence[i].match(reg_node)||[],kifu.propertyCount+=props.length;for(var j in props){ident=reg_ident.exec(props[j])[0],vals=props[j].match(reg_props);for(var k in vals)vals[k]=vals[k].substring(1,vals[k].length-1).replace(/\\(?!\\)/g,"");WGo.SGF.properties[ident]?WGo.SGF.properties[ident](kifu,node,vals,ident):(vals.length<=1&&(vals=vals[0]),node.parent?node[ident]=vals:kifu.info[ident]=vals)}}return kifu}}(WGo),function(WGo){"use strict";var FileError=function(path,code){this.name="FileError",this.message=1==code?"File '"+path+"' is empty.":2==code?"Network error. It is not possible to read '"+path+"'.":"File '"+path+"' hasn't been found on server."};(FileError.prototype=new Error).constructor=FileError,WGo.FileError=FileError;var loadFromUrl=WGo.loadFromUrl=function(url,callback){var xmlhttp=new XMLHttpRequest;xmlhttp.onreadystatechange=function(){if(4==xmlhttp.readyState){if(200!=xmlhttp.status)throw new FileError(url);if(0==xmlhttp.responseText.length)throw new FileError(url,1);callback(xmlhttp.responseText)}};try{xmlhttp.open("GET",url,!0),xmlhttp.send()}catch(err){throw new FileError(url,2)}},detect_scrolling=function(node,bp){return node!=bp.element&&node!=bp.element&&(!!(node._wgo_scrollable||node.scrollHeight>node.offsetHeight&&"auto"==window.getComputedStyle(node).overflow)||detect_scrolling(node.parentNode,bp))},Player=function(config){this.config=config;for(var key in Player.default)void 0===this.config[key]&&void 0!==Player.default[key]&&(this.config[key]=Player.default[key]);this.element=document.createElement("div"),this.board=new WGo.Board(this.element,this.config.board),this.init(),this.initGame()};Player.prototype={constructor:Player,init:function(){this.kifu=null,this.listeners={kifuLoaded:[function(e){this.board.setSize(e.kifu.size),this.board.removeAllObjects(),this.config.enableWheel&&this.setWheel(!0)}.bind(this)],update:[function(e){e.change&&this.board.update(e.change),this.temp_marks&&this.board.removeObject(this.temp_marks);var add=[];if(this.notification(),e.node.move&&this.config.markLastMove&&(e.node.move.pass?this.notification(WGo.t((e.node.move.c==WGo.B?"b":"w")+"pass")):add.push({type:"CR",x:e.node.move.x,y:e.node.move.y})),e.node.children.length>1&&this.config.displayVariations)for(i=0;i<e.node.children.length;i++)e.node.children[i].move&&!e.node.children[i].move.pass&&add.push({type:"LB",text:String.fromCharCode(65+i),x:e.node.children[i].move.x,y:e.node.children[i].move.y,c:this.board.theme.variationColor||"rgba(0,32,128,0.8)"});if(e.node.markup){for(var i in e.node.markup)for(var j=0;j<add.length;j++)e.node.markup[i].x==add[j].x&&e.node.markup[i].y==add[j].y&&(add.splice(j,1),j--);add=add.concat(e.node.markup)}this.temp_marks=add,this.board.addObject(add)}.bind(this)],frozen:[],unfrozen:[]},this.config.kifuLoaded&&this.addEventListener("kifuLoaded",this.config.kifuLoaded),this.config.update&&this.addEventListener("update",this.config.update),this.config.frozen&&this.addEventListener("frozen",this.config.frozen),this.config.unfrozen&&this.addEventListener("unfrozen",this.config.unfrozen),this.board.addEventListener("click",function(x,y){if(!this.kifuReader||!this.kifuReader.node)return!1;for(var i in this.kifuReader.node.children)if(this.kifuReader.node.children[i].move&&this.kifuReader.node.children[i].move.x==x&&this.kifuReader.node.children[i].move.y==y)return void this.next(i,!1)}.bind(this)),this.element.addEventListener("click",this.focus.bind(this)),this.focus()},initGame:function(){this.config.sgf?this.loadSgf(this.config.sgf,this.config.move):this.config.json?this.loadJSON(this.config.json,this.config.move):this.config.sgfFile&&this.loadSgfFromFile(this.config.sgfFile,this.config.move)},update:function(op){if(this.kifuReader&&this.kifuReader.change){var ev={type:"update",op:op,target:this,node:this.kifuReader.node,position:this.kifuReader.getPosition(),path:this.kifuReader.path,change:this.kifuReader.change};this.dispatchEvent(ev)}},loadKifu:function(kifu,path){this.kifu=kifu,this.kifuReader=new WGo.KifuReader(this.kifu,this.config.rememberPath,this.config.allowIllegalMoves),this.dispatchEvent({type:"kifuLoaded",target:this,kifu:this.kifu}),this.update("init"),path&&this.goTo(path)},loadSgf:function(sgf,path){try{this.loadKifu(WGo.Kifu.fromSgf(sgf),path)}catch(err){this.error(err)}},loadJSON:function(json,path){try{this.loadKifu(WGo.Kifu.fromJGO(json),path)}catch(err){this.error(err)}},loadSgfFromFile:function(file_path,game_path){var _this=this;try{loadFromUrl(file_path,function(sgf){_this.loadSgf(sgf,game_path)})}catch(err){this.error(err)}},addEventListener:function(type,listener){this.listeners[type]=this.listeners[type]||[],this.listeners[type].push(listener)},removeEventListener:function(type,listener){if(this.listeners[type]){var i=this.listeners[type].indexOf(listener);-1!=i&&this.listeners[type].splice(i,1)}},dispatchEvent:function(evt){if(this.listeners[evt.type])for(var l in this.listeners[evt.type])this.listeners[evt.type][l](evt)},notification:function(text){console&&text&&console.log(text)},help:function(text){console&&console.log(text)},error:function(err){if(!WGo.ERROR_REPORT)throw err;console&&console.log(err)},next:function(i,findAGMove){if(void 0===findAGMove&&(findAGMove=!0),!this.frozen&&this.kifu)try{this.kifuReader.next(i,findAGMove),this.update()}catch(err){this.error(err)}},previous:function(){if(!this.frozen&&this.kifu)try{this.kifuReader.previous(),this.update()}catch(err){this.error(err)}},last:function(){if(!this.frozen&&this.kifu)try{this.kifuReader.last(),this.update()}catch(err){this.error(err)}},first:function(){if(!this.frozen&&this.kifu)try{this.kifuReader.first(),this.update()}catch(err){this.error(err)}},goTo:function(move){if(!this.frozen&&this.kifu){var path;"function"==typeof move&&(move=move.call(this)),"number"==typeof move?(path=WGo.clone(this.kifuReader.path)).m=move||0:path=move;try{this.kifuReader.goTo(path),this.update()}catch(err){this.error(err)}}},getGameInfo:function(){if(!this.kifu)return null;var info={};for(var key in this.kifu.info)-1!=WGo.Kifu.infoList.indexOf(key)&&(WGo.Kifu.infoFormatters[key]?info[WGo.t(key)]=WGo.Kifu.infoFormatters[key](this.kifu.info[key]):info[WGo.t(key)]=WGo.filterHTML(this.kifu.info[key]));return info},setFrozen:function(frozen){this.frozen=frozen,this.dispatchEvent({type:this.frozen?"frozen":"unfrozen",target:this})},appendTo:function(elem){elem.appendChild(this.element)},focus:function(){this.config.enableKeys&&this.setKeys(!0)},setKeys:function(b){document.onkeydown=b?function(e){if(document.querySelector("input:focus, textarea:focus"))return!0;switch(e.keyCode){case 39:this.next();break;case 37:this.previous();break;default:return!0}return this.config.lockScroll&&e.preventDefault&&e.preventDefault(),!this.config.lockScroll}.bind(this):null},setWheel:function(b){if(!this._wheel_listener&&b){this._wheel_listener=function(e){var delta=e.wheelDelta||-1*e.detail;return!(!detect_scrolling(e.target,this)&&(delta<0?(this.next(),this.config.lockScroll&&e.preventDefault&&e.preventDefault(),this.config.lockScroll):delta>0&&(this.previous(),this.config.lockScroll&&e.preventDefault&&e.preventDefault(),this.config.lockScroll)))}.bind(this);type=void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";this.element.addEventListener(type,this._wheel_listener)}else if(this._wheel_listener&&!b){var type=void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll";this.element.removeEventListener(type,this._wheel_listener),delete this._wheel_listener}},setCoordinates:function(b){!this.coordinates&&b?(this.board.setSection(-.5,-.5,-.5,-.5),this.board.addCustomObject(WGo.Board.coordinates)):this.coordinates&&!b&&(this.board.setSection(0,0,0,0),this.board.removeCustomObject(WGo.Board.coordinates)),this.coordinates=b}},Player.default={sgf:void 0,json:void 0,sgfFile:void 0,move:void 0,board:{},enableWheel:!0,lockScroll:!0,enableKeys:!0,rememberPath:!0,kifuLoaded:void 0,update:void 0,frozen:void 0,unfrozen:void 0,allowIllegalMoves:!1,markLastMove:!0,displayVariations:!0},WGo.Player=Player;var player_terms={"about-text":"<h1>WGo.js Player 2.0</h1><p>WGo.js Player is extension of WGo.js, HTML5 library for purposes of game of go. It allows to replay go game records and it has many features like score counting. It is also designed to be easily extendable.</p><p>WGo.js is open source licensed under <a href='http://en.wikipedia.org/wiki/MIT_License' target='_blank'>MIT license</a>. You can use and modify any code from this project.</p><p>You can find more information at <a href='http://wgo.waltheri.net/player' target='_blank'>wgo.waltheri.net/player</a></p><p>Copyright &copy; 2013 Jan Prokop</p>",black:"Black",white:"White",DT:"Date",KM:"Komi",HA:"Handicap",AN:"Annotations",CP:"Copyright",GC:"Game comments",GN:"Game name",ON:"Fuseki",OT:"Overtime",TM:"Basic time",RE:"Result",RO:"Round",RU:"Rules",US:"Recorder",PC:"Place",EV:"Event",SO:"Source",none:"none",bpass:"Black passed.",wpass:"White passed."};for(var key in player_terms)WGo.i18n.en[key]=player_terms[key]}(WGo),function(WGo){"use strict";var pl_count=0,playerBlock=function(name,parent,visible){var e={};return e.element=document.createElement("div"),e.element.className="wgo-player-"+name,e.wrapper=document.createElement("div"),e.wrapper.className="wgo-player-"+name+"-wrapper",e.element.appendChild(e.wrapper),parent.appendChild(e.element),visible||(e.element.style.display="none"),e},BPgenerateDom=function(){this.dom={},this.dom.center=document.createElement("div"),this.dom.center.className="wgo-player-center",this.dom.board=document.createElement("div"),this.dom.board.className="wgo-player-board",this.regions={},this.regions.left=playerBlock("left",this.element),this.element.appendChild(this.dom.center),this.regions.right=playerBlock("right",this.element),this.regions.top=playerBlock("top",this.dom.center),this.dom.center.appendChild(this.dom.board),this.regions.bottom=playerBlock("bottom",this.dom.center)},getCurrentLayout=function(){var cl=this.config.layout;if(cl.constructor!=Array)return cl;for(var bh=this.height||this.maxHeight,i=0;i<cl.length;i++)if(!cl[i].conditions||(!cl[i].conditions.minWidth||cl[i].conditions.minWidth<=this.width)&&(!cl[i].conditions.minHeight||!bh||cl[i].conditions.minHeight<=bh)&&(!cl[i].conditions.maxWidth||cl[i].conditions.maxWidth>=this.width)&&(!cl[i].conditions.maxHeight||!bh||cl[i].conditions.maxHeight>=bh)&&(!cl[i].conditions.custom||cl[i].conditions.custom.call(this)))return cl[i]},appendComponents=function(area){var components;if(components=this.currentLayout.layout?this.currentLayout.layout[area]:this.currentLayout[area]){this.regions[area].element.style.display="block",components.constructor!=Array&&(components=[components]);for(var i in components)this.components[components[i]]||(this.components[components[i]]=new BasicPlayer.component[components[i]](this)),this.components[components[i]].appendTo(this.regions[area].wrapper),this.components[components[i]]._detachFromPlayer=!1}else this.regions[area].element.style.display="none"},manageComponents=function(){for(var key in this.components)this.components[key]._detachFromPlayer=!0;appendComponents.call(this,"left"),appendComponents.call(this,"right"),appendComponents.call(this,"top"),appendComponents.call(this,"bottom");for(var key in this.components)this.components[key]._detachFromPlayer&&this.components[key].element.parentNode&&this.components[key].element.parentNode.removeChild(this.components[key].element)},BasicPlayer=WGo.extendClass(WGo.Player,function(elem,config){this.config=config;for(var key in BasicPlayer.default)void 0===this.config[key]&&void 0!==BasicPlayer.default[key]&&(this.config[key]=BasicPlayer.default[key]);for(var key in WGo.Player.default)void 0===this.config[key]&&void 0!==WGo.Player.default[key]&&(this.config[key]=WGo.Player.default[key]);this.element=elem,this.element.innerHTML="",this.classes=(this.element.className?this.element.className+" ":"")+"wgo-player-main",this.element.className=this.classes,this.element.id||(this.element.id="wgo_"+pl_count++),BPgenerateDom.call(this),this.board=new WGo.Board(this.dom.board,this.config.board),this.init(),this.components={},window.addEventListener("resize",function(){this.noresize||this.updateDimensions()}.bind(this)),this.updateDimensions(),this.initGame()});BasicPlayer.prototype.appendTo=function(elem){elem.appendChild(this.element),this.updateDimensions()},BasicPlayer.prototype.updateDimensions=function(){for(var css=window.getComputedStyle(this.element),els=[];this.element.firstChild;)els.push(this.element.firstChild),this.element.removeChild(this.element.firstChild);for(var tmp_w=parseInt(css.width),tmp_h=parseInt(css.height),tmp_mh=parseInt(css.maxHeight)||0,i=0;i<els.length;i++)this.element.appendChild(els[i]);if(tmp_w!=this.width||tmp_h!=this.height||tmp_mh!=this.maxHeight){this.width=tmp_w,this.height=tmp_h,this.maxHeight=tmp_mh,this.currentLayout=getCurrentLayout.call(this),this.currentLayout&&this.lastLayout!=this.currentLayout&&(this.currentLayout.className?this.element.className=this.classes+" "+this.currentLayout.className:this.element.className=this.classes,manageComponents.call(this),this.lastLayout=this.currentLayout);var bw=this.dom.board.clientWidth,bh=this.height||this.maxHeight;bh&&(bh-=this.regions.top.element.offsetHeight+this.regions.bottom.element.offsetHeight),bh&&bh<bw?bh!=this.board.height&&this.board.setHeight(bh):bw!=this.board.width&&this.board.setWidth(bw);var diff=bh-bw;diff>0?(this.dom.board.style.height=bh+"px",this.dom.board.style.paddingTop=diff/2+"px"):(this.dom.board.style.height="auto",this.dom.board.style.paddingTop="0"),this.regions.left.element.style.height=this.dom.center.offsetHeight+"px",this.regions.right.element.style.height=this.dom.center.offsetHeight+"px";for(var i in this.components)this.components[i].updateDimensions&&this.components[i].updateDimensions()}},BasicPlayer.prototype.showMessage=function(text,closeCallback,permanent){this.info_overlay=document.createElement("div"),this.info_overlay.style.width=this.element.offsetWidth+"px",this.info_overlay.style.height=this.element.offsetHeight+"px",this.info_overlay.className="wgo-info-overlay",this.element.appendChild(this.info_overlay);var info_message=document.createElement("div");info_message.className="wgo-info-message",info_message.innerHTML=text;var close_info=document.createElement("div");close_info.className="wgo-info-close",permanent||(close_info.innerHTML=WGo.t("BP:closemsg")),info_message.appendChild(close_info),this.info_overlay.appendChild(info_message),closeCallback?this.info_overlay.addEventListener("click",function(e){closeCallback(e)}):permanent||this.info_overlay.addEventListener("click",function(e){this.hideMessage()}.bind(this)),this.setFrozen(!0)},BasicPlayer.prototype.hideMessage=function(){this.element.removeChild(this.info_overlay),this.setFrozen(!1)},BasicPlayer.prototype.error=function(err){if(!WGo.ERROR_REPORT)throw err;switch(err.name){case"InvalidMoveError":this.showMessage("<h1>"+err.name+"</h1><p>"+err.message+'</p><p>If this message isn\'t correct, please report it by clicking <a href="#">here</a>, otherwise contact maintainer of this site.</p>');break;case"FileError":this.showMessage("<h1>"+err.name+"</h1><p>"+err.message+"</p><p>Please contact maintainer of this site. Note: it is possible to read files only from this host.</p>");break;default:this.showMessage("<h1>"+err.name+"</h1><p>"+err.message+"</p><pre>"+err.stacktrace+'</pre><p>Please contact maintainer of this site. You can also report it <a href="#">here</a>.</p>')}},BasicPlayer.component={},BasicPlayer.layouts={one_column:{top:[],bottom:[]},no_comment:{top:[],bottom:[]},right_top:{top:[],right:[]},right:{right:[]},minimal:{bottom:[]}},BasicPlayer.dynamicLayout=[{conditions:{minWidth:650},layout:BasicPlayer.layouts.right_top,className:"wgo-twocols wgo-large"},{conditions:{minWidth:550,minHeight:600},layout:BasicPlayer.layouts.one_column,className:"wgo-medium"},{conditions:{minWidth:350},layout:BasicPlayer.layouts.no_comment,className:"wgo-small"},{layout:BasicPlayer.layouts.no_comment,className:"wgo-xsmall"}],BasicPlayer.default={layout:BasicPlayer.dynamicLayout},WGo.i18n.en["BP:closemsg"]="click anywhere to close this window",BasicPlayer.attributes={"data-wgo":function(value){value&&("("==value[0]?this.sgf=value:this.sgfFile=value)},"data-wgo-board":function(value){this.board=eval("({"+value+"})")},"data-wgo-onkifuload":function(value){this.kifuLoaded=new Function(value)},"data-wgo-onupdate":function(value){this.update=new Function(value)},"data-wgo-onfrozen":function(value){this.frozen=new Function(value)},"data-wgo-onunfrozen":function(value){this.unfrozen=new Function(value)},"data-wgo-layout":function(value){this.layout=eval("({"+value+"})")},"data-wgo-enablewheel":function(value){"false"==value.toLowerCase()&&(this.enableWheel=!1)},"data-wgo-lockscroll":function(value){"false"==value.toLowerCase()&&(this.lockScroll=!1)},"data-wgo-enablekeys":function(value){"false"==value.toLowerCase()&&(this.enableKeys=!1)},"data-wgo-rememberpath":function(value){"false"==value.toLowerCase()&&(this.rememberPath=!1)},"data-wgo-allowillegal":function(value){"false"!=value.toLowerCase()&&(this.allowIllegalMoves=!0)},"data-wgo-move":function(value){var m=parseInt(value);isNaN(m)?this.move=eval("({"+value+"})"):this.move=m},"data-wgo-marklastmove":function(value){"false"==value.toLowerCase()&&(this.markLastMove=!1)},"data-wgo-diagram":function(value){value&&("("==value[0]?this.sgf=value:this.sgfFile=value,this.markLastMove=!1,this.enableKeys=!1,this.enableWheel=!1,this.layout={top:[],right:[],left:[],bottom:[]})}};var player_from_tag=function(elem){var att,config,pl;config={board:{background:"/img/wood_1024.jpg"}};for(var a=0;a<elem.attributes.length;a++)att=elem.attributes[a],BasicPlayer.attributes[att.name]&&BasicPlayer.attributes[att.name].call(config,att.value,att.name);pl=new BasicPlayer(elem,config),elem._wgo_player=pl};WGo.BasicPlayer=BasicPlayer,window.addEventListener("load",function(){for(var pl_elems=document.querySelectorAll("[data-wgo],[data-wgo-diagram]"),i=0;i<pl_elems.length;i++)player_from_tag(pl_elems[i])})}(WGo),function(WGo,undefined){"use strict";var Component=function(){this.element=document.createElement("div")};Component.prototype={constructor:Component,appendTo:function(target){target.appendChild(this.element)},getWidth:function(){var css=window.getComputedStyle(this.element);return parseInt(css.width)},getHeight:function(){var css=window.getComputedStyle(this.element);return parseInt(css.height)},updateDimensions:function(){}},WGo.BasicPlayer.component.Component=Component}(WGo),function(WGo,undefined){"use strict";var Control=WGo.extendClass(WGo.BasicPlayer.component.Component,function(player){this.super(player),this.widgets=[],this.element.className="wgo-player-control",function(player){this.iconBar=document.createElement("div"),this.iconBar.className="wgo-control-wrapper",this.element.appendChild(this.iconBar);var widget;for(var w in Control.widgets)(widget=new Control.widgets[w].constructor(player,Control.widgets[w].args)).appendTo(this.iconBar),this.widgets.push(widget)}.call(this,player)});Control.prototype.updateDimensions=function(){this.element.clientWidth<340?this.element.className="wgo-player-control wgo-340":this.element.clientWidth<440?this.element.className="wgo-player-control wgo-440":this.element.className="wgo-player-control"};var control=WGo.BasicPlayer.control={},butupd_first=function(e){e.node.parent||this.disabled?e.node.parent&&this.disabled&&this.enable():this.disable()},butupd_last=function(e){e.node.children.length||this.disabled?e.node.children.length&&this.disabled&&this.enable():this.disable()},but_frozen=function(e){this._disabled=this.disabled,this.disabled||this.disable()},but_unfrozen=function(e){this._disabled||this.enable(),delete this._disabled};control.Widget=function(player,args){this.element=this.element||document.createElement(args.type||"div"),this.element.className="wgo-widget-"+args.name,this.init(player,args)},control.Widget.prototype={constructor:control.Widget,init:function(player,args){args&&(args.disabled&&this.disable(),args.init&&args.init.call(this,player))},appendTo:function(target){target.appendChild(this.element)},disable:function(){this.disabled=!0,-1==this.element.className.search("wgo-disabled")&&(this.element.className+=" wgo-disabled")},enable:function(){this.disabled=!1,this.element.className=this.element.className.replace(" wgo-disabled",""),this.element.disabled=""}},control.Group=WGo.extendClass(control.Widget,function(player,args){this.element=document.createElement("div"),this.element.className="wgo-ctrlgroup wgo-ctrlgroup-"+args.name;for(var w in args.widgets)new args.widgets[w].constructor(player,args.widgets[w].args).appendTo(this.element)}),control.Clickable=WGo.extendClass(control.Widget,function(player,args){this.super(player,args)}),control.Clickable.prototype.init=function(player,args){var fn,_this=this;fn=args.togglable?function(){_this.disabled||(args.click.call(_this,player)?_this.select():_this.unselect())}:function(){_this.disabled||args.click.call(_this,player)},this.element.addEventListener("click",fn),this.element.addEventListener("touchstart",function(e){return e.preventDefault(),fn(),args.multiple&&(_this._touch_i=0,_this._touch_int=window.setInterval(function(){_this._touch_i>500&&fn(),_this._touch_i+=100},100)),!1}),args.multiple&&this.element.addEventListener("touchend",function(e){window.clearInterval(_this._touch_int)}),args.disabled&&this.disable(),args.init&&args.init.call(this,player)},control.Clickable.prototype.select=function(){this.selected=!0,-1==this.element.className.search("wgo-selected")&&(this.element.className+=" wgo-selected")},control.Clickable.prototype.unselect=function(){this.selected=!1,this.element.className=this.element.className.replace(" wgo-selected","")},control.Button=WGo.extendClass(control.Clickable,function(player,args){var elem=this.element=document.createElement("button");elem.className="wgo-button wgo-button-"+args.name,elem.title=WGo.t(args.name),this.init(player,args)}),control.Button.prototype.disable=function(){control.Button.prototype.super.prototype.disable.call(this),this.element.disabled="disabled"},control.Button.prototype.enable=function(){control.Button.prototype.super.prototype.enable.call(this),this.element.disabled=""},control.MenuItem=WGo.extendClass(control.Clickable,function(player,args){var elem=this.element=document.createElement("div");elem.className="wgo-menu-item wgo-menu-item-"+args.name,elem.title=WGo.t(args.name),elem.innerHTML=elem.title,this.init(player,args)}),control.MoveNumber=WGo.extendClass(control.Widget,function(player){this.element=document.createElement("form"),this.element.className="wgo-player-mn-wrapper";var move=this.move=document.createElement("input");move.type="text",move.value="0",move.maxlength=3,move.className="wgo-player-mn-value",this.element.appendChild(move),this.element.onsubmit=move.onchange=function(player){var newMove=parseInt(this.getValue(),10);if(newMove<0||newMove>100)return!1;var oldMove=player.kifuReader.path.m;if(newMove>oldMove)for(i=oldMove;i<newMove;i++)player.next();else for(var i=oldMove;i>newMove;i--)player.previous();return!1}.bind(this,player),player.addEventListener("update",function(e){this.setValue(e.path.m)}.bind(this)),player.addEventListener("kifuLoaded",this.enable.bind(this)),player.addEventListener("frozen",this.disable.bind(this)),player.addEventListener("unfrozen",this.enable.bind(this))}),control.MoveNumber.prototype.disable=function(){control.MoveNumber.prototype.super.prototype.disable.call(this),this.move.disabled="disabled"},control.MoveNumber.prototype.enable=function(){control.MoveNumber.prototype.super.prototype.enable.call(this),this.move.disabled=""},control.MoveNumber.prototype.setValue=function(n){this.move.value=n},control.MoveNumber.prototype.getValue=function(){return parseInt(this.move.value)};var player_menu=function(player){if(!player._menu_tmp){if(!player.menu){player.menu=document.createElement("div"),player.menu.className="wgo-player-menu",player.menu.style.position="absolute",player.menu.style.display="none",this.element.parentElement.appendChild(player.menu);for(var i in Control.menu)new Control.menu[i].constructor(player,Control.menu[i].args,!0).appendTo(player.menu)}if("none"!=player.menu.style.display)return player.menu.style.display="none",document.removeEventListener("click",player._menu_ev),delete player._menu_ev,this.unselect(),!1;player.menu.style.display="block";var top=this.element.offsetTop,left=this.element.offsetLeft;return this.element.parentElement.parentElement.parentElement.parentElement==player.regions.bottom.wrapper?(player.menu.style.left=left+"px",player.menu.style.top=top-player.menu.offsetHeight+1+"px"):(player.menu.style.left=left+"px",player.menu.style.top=top+this.element.offsetHeight+"px"),player._menu_ev=player_menu.bind(this,player),player._menu_tmp=!0,document.addEventListener("click",player._menu_ev),!0}delete player._menu_tmp};Control.menu=[{constructor:control.MenuItem,args:{name:"switch-coo",togglable:!0,click:function(player){return player.setCoordinates(!player.coordinates),player.coordinates},init:function(player){player.coordinates&&this.select()}}}],Control.widgets=[{constructor:control.Group,args:{name:"left",widgets:[{constructor:control.Button,args:{name:"menu",togglable:!0,click:player_menu}}]}},{constructor:control.Group,args:{name:"right",widgets:[{constructor:control.Button,args:{name:"about",click:function(player){player.showMessage(WGo.t("about-text"))}}}]}},{constructor:control.Group,args:{name:"control",widgets:[{constructor:control.Button,args:{name:"first",disabled:!0,init:function(player){player.addEventListener("update",butupd_first.bind(this)),player.addEventListener("frozen",but_frozen.bind(this)),player.addEventListener("unfrozen",but_unfrozen.bind(this))},click:function(player){player.first()}}},{constructor:control.Button,args:{name:"multiprev",disabled:!0,multiple:!0,init:function(player){player.addEventListener("update",butupd_first.bind(this)),player.addEventListener("frozen",but_frozen.bind(this)),player.addEventListener("unfrozen",but_unfrozen.bind(this))},click:function(player){for(var i=0;i<10;i++)player.previous()}}},{constructor:control.Button,args:{name:"previous",disabled:!0,multiple:!0,init:function(player){player.addEventListener("update",butupd_first.bind(this)),player.addEventListener("frozen",but_frozen.bind(this)),player.addEventListener("unfrozen",but_unfrozen.bind(this))},click:function(player){player.previous()}}},{constructor:control.MoveNumber},{constructor:control.Button,args:{name:"next",disabled:!0,multiple:!0,init:function(player){player.addEventListener("update",butupd_last.bind(this)),player.addEventListener("frozen",but_frozen.bind(this)),player.addEventListener("unfrozen",but_unfrozen.bind(this))},click:function(player){player.next()}}},{constructor:control.Button,args:{name:"multinext",disabled:!0,multiple:!0,init:function(player){player.addEventListener("update",butupd_last.bind(this)),player.addEventListener("frozen",but_frozen.bind(this)),player.addEventListener("unfrozen",but_unfrozen.bind(this))},click:function(player){for(var i=0;i<10;i++)player.next()}}},{constructor:control.Button,args:{name:"last",disabled:!0,init:function(player){player.addEventListener("update",butupd_last.bind(this)),player.addEventListener("frozen",but_frozen.bind(this)),player.addEventListener("unfrozen",but_unfrozen.bind(this))},click:function(player){player.last()}}}]}}];var bp_layouts=WGo.BasicPlayer.layouts;bp_layouts.right_top.top.push("Control"),bp_layouts.right.right.push("Control"),bp_layouts.one_column.top.push("Control"),bp_layouts.no_comment.bottom.push("Control"),bp_layouts.minimal.bottom.push("Control");var player_terms={about:"About",first:"First",multiprev:"10 moves back",previous:"Previous",next:"Next",multinext:"10 moves forward",last:"Last","switch-coo":"Display coordinates",menu:"Menu"};for(var key in player_terms)WGo.i18n.en[key]=player_terms[key];WGo.BasicPlayer.component.Control=Control}(WGo);